"""doc"""
# pylint: disable=R0801
import asyncio
from email import message
import logging
import os
import string
from typing import Optional, Union

from wechaty_puppet import FileBox, ScanStatus  # type: ignore
from datetime import datetime


from wechaty import Wechaty, Contact
from wechaty.user import Message, Room
from apscheduler.schedulers.asyncio import AsyncIOScheduler


os.environ['TOKEN'] = "padtokern here"
os.environ['WECHATY_PUPPET'] = "wechaty-puppet-padlocal"
os.environ['WECHATY_PUPPET_SERVICE_ENDPOINT'] = "ip adderss and port"
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)


def roomid_add(newroomid):
    #bussiness_Roomlist.add(newroomid)
    bussiness_Roomlist.append(newroomid)


class MyBot(Wechaty):
    """
    listen wechaty event with inherited functions, which is more friendly for
    oop developer
    """
    def __init__(self):
        super().__init__()

    async def on_message(self, msg: Message):
        """
        listen for message event
        """
        from_contact = msg.talker()
        text = msg.text()
        room = msg.room()
        #å¢åŠ ä»£ç 
        if text == '#ding':
            conversation: Union[
                Room, Contact] = from_contact if room is None else room
            await conversation.ready()
            await conversation.say('dong')
            file_box = FileBox.from_url(
                'https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/'
                'u=1116676390,2305043183&fm=26&gp=0.jpg',
                name='ding-dong.jpg')
            await conversation.say(file_box)
        if text == 'å‰§æœ¬æ€':
            room.say('æˆ‘çœ‹åˆ°å‰§æœ¬æ€ä¸‰ä¸ªå­—äº†')
            Yesornomention = await msg.mention_self()
            if not Yesornomention:
# mentionself å–åå€¼
            #mention_text() æ˜¯ä¸ªcoroutine nerver awaited
                await room.say('æˆ‘è¢«å‰§æœ¬æ€æåŠäº†')
                if room.room_id not in bussiness_Roomlist:
                    await room.say('è¿™æ˜¯ä¸ªæ–°ä¸–ç•Œï¼Œæˆ‘å‡†å¤‡åŠ å…¥äº†')
                    roomid_add(room.room_id)
                    await room.say('æˆ‘èµ°è¿›äº†è¿™ä¸ªä¸–ç•Œï¼Œè¿™ä¸ªä¸–ç•Œçš„IDæ˜¯')
                    await room.say(room.room_id)



            #bussiness_Roomlist = bussiness_Roomlist.add(from_contact.get_id())
                # roomid_add(room.room_id)
                # await room.say('å¾ˆé«˜å…´æ¥åˆ°æ–°ä¸–ç•Œï¼Œè¿™å¯¹æˆ‘æ˜¯ä¸ªæ–°çš„room')
                # await room.say(str(bussiness_Roomlist))

# and msg.to() is None and msg.mention_self() and room.room_id not in bussiness_Roomlist
    


                


    async def on_login(self, contact: Contact):
        print(f'user: {contact} has login')

    async def on_scan(self, status: ScanStatus, qr_code: Optional[str] = None,
                      data: Optional[str] = None):
        contact = self.Contact.load(self.contact_id)
        print(f'user <{contact}> scan status: {status.name} , '
              f'qr_code: {qr_code}')

# async def tick(bot:Wechaty):
#     room = bot.Room.load('<25398595775')
#     await room.ready()
#     from datetime import datetime
#     await room.say('hello ,room')

async def tick(roomnumber):
    """
    find a specific room, and say something to it.
    """
    roomnumber = roomnumber
    room = bot.Room.load(roomnumber)
    await room.ready()
    await room.say(str(bussiness_Roomlist))
    await room.say('æˆ‘åœ¨å‘å¸ƒç»„å±€ä¿¡æ¯')

    # loop = asyncio.get_event_loop()
    # task = [asyncio.ensure_future(sendMessageto(i)) for i in bussiness_Roomlist]
    # loop.run_until_complete(asyncio.wait(task))


# async def sendMessageto(i):
#     room = bot.Room.load(i)
#     await room.ready()
#     await room.say('ğŸ§§æœ‰è¶£äººç±»å®æ··ä¸­å¿ƒğŸ§§\nğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§ğŸ§§\n2ï¸âƒ£ğŸˆ·ï¸5ï¸âƒ£å¤§å¹´åˆäº”æ˜ŸæœŸå…­ğŸˆµï¸\n13:00ã€Šåˆ€é˜ã€‹æœºåˆ¶æ²‰æµ¸7ğŸˆµï¸\nåˆ¶3å°å§å§ç­‰5äººğŸˆµï¸\n')

#     miniProgram = new MiniProgram ({
#   appid              : 'gh_0aa444a25adc',
#   title              : 'æˆ‘æ­£åœ¨ä½¿ç”¨Authingè®¤è¯èº«ä»½ï¼Œä½ ä¹Ÿæ¥è¯•è¯•å§',
#   pagePath           : 'routes/explore.html',
#   description        : 'èº«ä»½ç®¡å®¶',
#   thumbUrl           : '30590201000452305002010002041092541302033d0af802040b30feb602045df0c2c5042b777875706c6f61645f31373533353339353230344063686174726f6f6d3131355f313537363035393538390204010400030201000400',
#   thumbKey           : '42f8609e62817ae45cf7d8fefb532e83',
# })
    # await room.say(miniProgram)



# 
bot: Optional[MyBot] = None


async def main():
    
    """doc"""
    global bussiness_Roomlist
    bussiness_Roomlist = {'25398595775@chatroom','1231@chatroom'}

    # pylint: disable=W0603
    global bot
    bot = MyBot()
    bussiness_Roomlist = ['25398595775@chatroom','20492732200@chatroom']
    scheduler = AsyncIOScheduler()
    for i in bussiness_Roomlist:
        scheduler.add_job(tick,'cron', hour = '3-22', minute = '1-59', args=[i])
    # scheduler.add_job(tick, 'cron', hour = '5-22', minute = '1-20', args=[bot])
    scheduler.start()
    
    await bot.start()


asyncio.run(main())
